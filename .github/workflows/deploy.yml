steps:
  - name: Checkout code
  uses: actions/checkout@v4

  - name: Set up Google Cloud
  uses: google-github-actions/setup-gcloud@v2
  with:
    service_account_key: ${{ secrets.GCP_SERVICE_KEY }}
    project_id: ${{ secrets.GCP_PROJECT_ID }}

  - name: Configure Docker auth
  run: |
    gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

  - name: Build Docker image
  run: |
    docker build -t ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/studyplanner/studyplanner:latest .

  - name: Push Docker image
  run: |
    docker push ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/studyplanner/studyplanner:latest

  - name: Deploy to Cloud Run
  run: |
    gcloud run deploy studyplanner \
    --image ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/studyplanner/studyplanner:latest \
    --region ${{ secrets.GCP_REGION }} \
    --platform managed \
    --allow-unauthenticated \
    --port 8080